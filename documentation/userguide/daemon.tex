\documentclass[notoc]{tufte-book}    % `notoc` suppresses TL custom TOC, reverts to standard LaTeX

\hyphenation{HMMER}

\input{titlepage_daemon}                    % definitions for \maketitle 
\bibliographystyle{unsrtnat-brief}   % customized natbib unsrtnat. Abbrev 3+ authors to ``et al.'' 

\begin{document}
\setcounter{tocdepth}{2}             % 0=chapters 1=sections 2=subsections 3=subsubsections? 4=paragraphs
\input{inclusions/inclusions.def}    % snippets captured from output, by gen-inclusions.py 

\maketitle

\input{copyright}

\begin{adjustwidth}{}{-1in}          % TL \textwidth is quite narrow. Expand it manually for TOC and man pages.
\tableofcontents                     
\end{adjustwidth}

In addition to command-line homology search tools such as hmmsearch, hmmscan, and phmmer, the HMMER package provides {\em hmmpgmd}, a tool that allows a set of computers to provide a high-performance homology search service that client machines can send searches to and receive results from using internet sockets.  Unlike HMMER's command-line search tools, which read their sequence or HMM databases from disk on every search, hmmpgmd reads its input database(s) once when it starts and caches them in RAM for the duration of its execution.  This avoids the performance bottleneck created by disk I/O bandwidth and the time required to parse input data files, allowing hmmpgmd to take full advantage of many-core CPUs and multi-CPU servers.  Distributing the work of each search across multiple computers further improves performance, allowing many searches to be completed in only a few seconds.

This manual describes the design implementation, and usage of hmmpgmd.  It assumes that the reader is familiar with HMMER and homology search in general; readers unfamiliar with those topics should read the {\em HMMER User's Guide} first.  This manual is intended for individuals who are interested in either running an hmmpgmd server of their own or in writing clients that communicate with an existing hmmpgmd server, and thus assumes a fair amount of familiarity with computer systems and programming.  Biologists who wish to use an hmmpgmd server in their research without the complexity of configuring one themselves should consider using the European Bioinformatics Institute's HMMER server {\tt www.ebi.ac.uk/Tools/hmmer/}, which provides a web interface to hmmpgmd servers that load a number of common genetic databases.
 

\chapter{Overview}


\chapter{Usage}

\chapter{Daemon-Client Interface}
Client machines use internet sockets to send commands to and receive results from a daemon's master node.  When a client opens a connection to the master node's client communication port (port 51371 by default), the master node forks a thread to manage the connection with the client.  This thread configures a socket to communicate with the client and then repeatedly calls the {\tt clientside\_loop} function, which monitors the socket for commands from the client, until either the client detatches from the port or the daemon shuts down.  This approach allows multiple clients to connect to a daemon simultaneously without interfering with each other, although requests from one client may impact the amount of time it takes for the daemon to respond to requests from other clients.

\section{Daemon Command Format}
Commands from a client to a daemon are variable-length sequences of ASCII text that are terminated by a line containing only two forward slashes ("{\tt //}").  When a command arrives from a client, the daemon reads bytes from the appropriate socket into a buffer until it sees the end-of-command sequence, growing the buffer as necessary\sidenote{This is a security vulnerability that should be addressed in HMMER4, as it allows an adversarial or erroneous client to consume arbitrary amounts of RAM, potentially exceeding the capacity of the master node.}, and then parses the contents of the buffer in order to execute the command.   

\section{Search Results Format}
The results from each search are split across two sockets messages.  The first is a fixed-length {\tt HMMD\_SEARCH\_STATUS} structure that contains two fields: a {\em status} field that contains any error information from the search, and a {\em msg\_size} field, which tells the client how large (in bytes) the second message will be.  The format of the second message depends on whether any errors were encountered during the search.  If an error occurs, the second message is simply a text string containing a description of the error.  In this case, the {\em status} field of the first message contans one of the Easel error codes, and the {\tt msg\_length} field contains the length of the error description string, including its termination character.

If the search succeeds, the {\tt status} field of the first message is set to "eslOK\sidenote{This assignment is done by the {\tt init\_results} function.}" and the second message contains the results of the search.  This message begins with   


\input{ack}
\label{manualend}

% To create distributable/gitted 'distilled.bib' from lab's bibtex dbs:
%   # uncomment the {master,lab,books}
%   pdflatex main
%   bibdistill main.aux > distilled.bib
%   # restore the {distilled} 
% 
\nobibliography{distilled}
%\nobibliography{master,lab,books}

\end{document}



